name: Label Issues by Keyword

on:
  issues:
    types: [opened, edited]

jobs:
  label-issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: Label issue based on keywords
        uses: actions/github-script@v7
        with:
          script: |
            // Ensure labels exist
            const labels = ['bug', 'feature'];
            for (const label of labels) {
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label
                });
              } catch (error) {
                if (error.status === 404) {
                  // Create label
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: label,
                    color: label === 'bug' ? 'd73a4a' : '0075ca',
                    description: label === 'bug' ? 'Something isn\'t working' : 'New feature or request'
                  });
                } else {
                  throw error;
                }
              }
            }

            // Get issue data
            const title = context.payload.issue.title.toLowerCase();
            const body = context.payload.issue.body ? context.payload.issue.body.toLowerCase() : '';
            const text = title + ' ' + body;
            
            const labelsToAdd = [];
            if (text.includes('error')) {
              labelsToAdd.push('bug');
            }
            if (text.includes('add')) {
              labelsToAdd.push('feature');
            }

            if (labelsToAdd.length > 0) {
              // Add labels to issue
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                labels: labelsToAdd
              });
            }